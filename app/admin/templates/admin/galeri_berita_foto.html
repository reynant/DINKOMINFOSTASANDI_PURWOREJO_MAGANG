<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gallery Berita Foto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>
    <style>
      .invalid-feedback {
        display: none;
        color: red;
        font-size: 0.875em;
      }
      .is-invalid {
        border-color: #dc3545;
      }
      .preview-image {
        max-width: 100px;
        max-height: 100px;
        margin-top: 10px;
        border-radius: 5px;
        display: none;
      }
      /* Pastikan button tidak disabled */
      .btn:not(:disabled) {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    {% include "admin/sidebar.html" %}
    <div class="container mt-4">
      <h3>Dashboard</h3>
      
      <!-- Alert untuk menampilkan flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Gallery Berita Foto</h5>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTambah">
            Tambahkan Data
          </button>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
              Show
              <select class="form-select form-select-sm mx-2" id="entriesSelect" style="width:auto">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              entries
            </div>
            <div>
              <input type="search" class="form-control form-control-sm" id="searchInput" placeholder="Search..." onkeyup="filterTable()"/>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm" id="galleryTable">
              <thead class="table-light">
                <tr>
                  <th>No</th>
                  <th>Foto</th>
                  <th>Judul Foto</th>
                  <th>Nama Album</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                {% if galeri and galeri|length > 0 %}
                  {% for foto in galeri %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                      {% if foto.Foto %}
                        <img src="{{ url_for('static', filename=foto.Foto) }}" 
                             alt="{{ foto.Judul_Foto }}" 
                             style="width:60px; height:60px; object-fit:cover; border-radius:5px;" />
                      {% else %}
                        <span class="text-muted">No Image</span>
                      {% endif %}
                    </td>
                    <td>{{ foto.Judul_Foto }}</td>
                    <td>{{ foto.Nama_Album }}</td>
                    <td>
                      <!-- Tombol Edit (kuning) -->
                      <button class="btn btn-warning btn-sm me-1" 
                              data-id="{{ foto.Id }}"
                              data-foto="{{ foto.Foto }}"
                              data-judul-foto="{{ foto.Judul_Foto }}"
                              data-nama-album="{{ foto.Nama_Album }}"
                              data-bs-toggle="modal"
                              data-bs-target="#modalEdit"
                              onclick="setEditData(this)">
                        Edit
                      </button>
                      
                      <!-- Tombol Hapus (merah) -->
                      <form method="POST" action="{{ url_for('admin.hapus_galeri_berita_foto', id=foto.Id) }}" style="display:inline">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Yakin ingin menghapus data ini?')">
                          Hapus
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center">No data available in table</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <span>Showing 1 to {{ galeri|length if galeri else 0 }} of {{ galeri|length if galeri else 0 }} entries</span>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><a href="#" class="page-link disabled">Previous</a></li>
                <li class="page-item active"><a href="#" class="page-link">1</a></li>
                <li class="page-item"><a href="#" class="page-link disabled">Next</a></li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
      <footer class="mt-4 text-center text-sm text-gray-500">
        <p>
          Copyright Â© 2014-2025
          <a href="#" class="text-blue-700 font-semibold">
            Dinas Komunikasi, Informatika, Statistik dan Persandian Kabupaten Purworejo
          </a>.
          All rights reserved. Version 3.0.0
        </p>
      </footer>
    </div>
    
    <!-- Modal Tambah -->
    <div class="modal fade" id="modalTambah" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('admin.tambah_galeri_berita_foto') }}" enctype="multipart/form-data" novalidate>
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Tambah Foto Gallery</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Foto</label>
                <input type="file" name="foto" id="foto" class="form-control" accept="image " required onchange="previewImage(this, 'previewFoto')" />
                <div class="invalid-feedback">Foto harus diisi</div>
                <img id="previewFoto" class="preview-image" alt="Preview Foto" />
              </div>
              <div class="mb-3">
                <label class="form-label">Judul Foto</label>
                <input type="text" name="judul_foto" class="form-control" required />
                <div class="invalid-feedback">Judul foto harus diisi</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Nama Album</label>
                <input type="text" name="nama_album" class="form-control" required />
                <div class="invalid-feedback">Nama album harus diisi</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="submit" class="btn btn-primary">Simpan</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Modal Edit -->
    <div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="form-edit" method="POST" enctype="multipart/form-data" novalidate>
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Foto Gallery</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="edit-id" name="id" />
              <div class="mb-3">
                <label class="form-label">Foto</label>
                <input type="file" id="edit-foto" name="foto" class="form-control" accept="image/*" onchange="previewImage(this, 'previewEditFoto')" />
                <div class="invalid-feedback">Format file tidak valid</div>
                <img id="previewEditFoto" class="preview-image" alt="Preview Foto" />
                <div id="current-foto" class="mt-2"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Judul Foto</label>
                <input type="text" id="edit-judul-foto" name="judul_foto" class="form-control" required />
                <div class="invalid-feedback">Judul foto harus diisi</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Nama Album</label>
                <input type="text" id="edit-nama-album" name="nama_album" class="form-control" required />
                <div class="invalid-feedback">Nama album harus diisi</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Pastikan JavaScript Bootstrap di-load dengan benar -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Fungsi untuk set data edit
      function setEditData(btn) {
        console.log('setEditData called', btn);
        
        document.getElementById("edit-id").value = btn.getAttribute("data-id");
        document.getElementById("edit-judul-foto").value = btn.getAttribute("data-judul-foto");
        document.getElementById("edit-nama-album").value = btn.getAttribute("data-nama-album");
        
        // Tampilkan foto saat ini
        const currentFoto = btn.getAttribute("data-foto");
        const currentFotoElement = document.getElementById("current-foto");
        if (currentFoto) {
          const fotoPath = currentFoto.startsWith('uploads/') ? "{{ url_for('static', filename='') }}" + currentFoto : currentFoto;
          currentFotoElement.innerHTML = `
            <small class="text-muted">Foto saat ini:</small><br>
            <img src="${fotoPath}" alt="Current Foto" style="max-width: 100px; max-height: 100px; border-radius: 5px;">
          `;
        } else {
          currentFotoElement.innerHTML = '<small class="text-muted">Tidak ada foto</small>';
        }
        
        document.getElementById("form-edit").action = "/admin/edit_galeri_berita_foto/" + btn.getAttribute("data-id");
      }
      
      // Fungsi filter tabel
      function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("galleryTable");
        const trs = table.getElementsByTagName("tr");
        
        for (let i = 1; i < trs.length; i++) {
          const td = trs[i].getElementsByTagName("td")[2]; // kolom Judul Foto
          if (td) {
            const text = td.textContent || td.innerText;
            trs[i].style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
          }
        }
      }
      
      // Fungsi preview gambar
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const file = input.files[0];
        
        if (file) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
          }
          
          reader.readAsDataURL(file);
        } else {
          preview.style.display = 'none';
        }
      }
      
      // Validasi form
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing form validation');
        
        const forms = document.querySelectorAll('form[novalidate]');
        
        forms.forEach(form => {
          form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
              
              // Tampilkan pesan error untuk setiap field
              const inputs = form.querySelectorAll('input');
              inputs.forEach(input => {
                if (!input.checkValidity()) {
                  input.classList.add('is-invalid');
                  const feedback = input.nextElementSibling;
                  if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'block';
                  }
                } else {
                  input.classList.remove('is-invalid');
                  const feedback = input.nextElementSibling;
                  if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'none';
                  }
                }
              });
            }
            
            form.classList.add('was-validated');
          });
        });
        
        // Inisialisasi tooltips jika ada
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
      
      // Debug: Check if Bootstrap is loaded
      console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
    </script>
  </body>
</html>